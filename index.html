<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#09090B">
<title>Docks del Puerto â€” Agenda</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#09090B;--s1:#111113;--s2:#18181B;--s3:#1F1F23;--s4:#27272A;
  --brd:rgba(255,255,255,.06);--brd2:rgba(255,255,255,.09);--brd3:rgba(255,255,255,.14);
  --t1:#FAFAFA;--t2:#A1A1AA;--t3:#71717A;--t4:#52525B;--t5:#3F3F46;
  --r:#DC2626;--r2:#B91C1C;--r-bg:rgba(220,38,38,.07);--r-brd:rgba(220,38,38,.18);
  --r-glow:rgba(220,38,38,.15);
  --c-prov:#3B82F6;--c-cli:#10B981;--c-staff:#F59E0B;--c-serv:#8B5CF6;--c-pers:#EC4899;--c-otro:#71717A;
  --rd:12px;--rd2:8px;--rd3:16px;
  --f:'Sora',system-ui,sans-serif;--fm:'Space Mono',monospace;
  --sh1:0 1px 3px rgba(0,0,0,.3),0 0 1px rgba(255,255,255,.03);
  --sh2:0 4px 16px rgba(0,0,0,.4),0 0 1px rgba(255,255,255,.05);
  --sh3:0 16px 48px rgba(0,0,0,.5),0 0 1px rgba(255,255,255,.06);
}
html{height:100%;background:var(--bg)}
body{font-family:var(--f);color:var(--t1);-webkit-font-smoothing:antialiased;background:var(--bg)}
::selection{background:var(--r);color:#fff}
.app{max-width:880px;margin:0 auto;padding:0 24px 80px}

/* â•â•â• SYNC STATUS BAR â•â•â• */
.sync-bar{position:fixed;top:0;left:0;right:0;z-index:200;height:3px;background:transparent;pointer-events:none}
.sync-bar.syncing{background:linear-gradient(90deg,transparent,var(--r),transparent);animation:syncPulse 1.5s ease infinite}
.sync-bar.online{background:var(--c-cli);animation:syncFade 2s ease forwards}
.sync-bar.offline{background:#EF4444;animation:none}
@keyframes syncPulse{0%,100%{opacity:.3}50%{opacity:1}}
@keyframes syncFade{0%{opacity:1}100%{opacity:0}}

/* â•â•â• CONNECTION INDICATOR â•â•â• */
.conn-dot{width:8px;height:8px;border-radius:50%;background:#22C55E;display:inline-block;margin-right:6px;flex-shrink:0;transition:background .3s}
.conn-dot.offline{background:#EF4444;animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* â•â•â• HEADER â•â•â• */
.hd{position:sticky;top:0;z-index:50;margin:0 -24px;padding:0 24px;background:rgba(9,9,11,.92);backdrop-filter:blur(24px) saturate(180%);-webkit-backdrop-filter:blur(24px) saturate(180%);border-bottom:1px solid var(--brd)}
.hd-top{display:flex;justify-content:space-between;align-items:center;padding:14px 0}
.hd-brand{display:flex;align-items:center;gap:12px}
.hd-mark{width:34px;height:34px;background:var(--r);border-radius:8px;display:flex;align-items:center;justify-content:center;font:800 13px/1 var(--f);color:#fff;letter-spacing:-.5px;position:relative;overflow:hidden}
.hd-mark::after{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:rgba(255,255,255,.12)}
.hd-name{font:700 15px/1 var(--f);color:var(--t1);letter-spacing:-.5px}
.hd-sub{font:400 9px/1.3 var(--f);color:var(--t4);margin-top:2px;letter-spacing:.5px;text-transform:uppercase}
.hd-r{display:flex;gap:20px;align-items:center}
.stat{text-align:center}
.stat b{font:800 22px/1 var(--f);color:var(--t1);display:block;letter-spacing:-1px}
.stat span{font:400 8px/1.4 var(--f);color:var(--t4);text-transform:uppercase;letter-spacing:1.5px}

/* Lock button */
.lock-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--brd2);background:var(--s2);color:var(--t3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.lock-btn:hover{border-color:var(--brd3);color:var(--t2)}
.lock-btn.unlocked{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.08);color:#22C55E}

/* â•â•â• TOOLBAR â•â•â• */
.tb{display:flex;gap:10px;margin:20px 0 16px;flex-wrap:wrap}
.sb{flex:1;min-width:200px;position:relative}
.sb svg{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--t4);pointer-events:none}
.si{width:100%;padding:10px 12px 10px 40px;border:1px solid var(--brd2);border-radius:var(--rd);background:var(--s2);color:var(--t1);font:400 13px var(--f);outline:none;transition:border-color .2s}
.si:focus{border-color:var(--r)}
.si::placeholder{color:var(--t4)}
.btn{padding:10px 16px;border-radius:var(--rd);border:1px solid var(--brd2);background:var(--s2);color:var(--t2);font:500 12px var(--f);cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s;white-space:nowrap}
.btn:hover{border-color:var(--brd3);color:var(--t1);background:var(--s3)}
.btn-r{background:var(--r);border-color:var(--r);color:#fff}
.btn-r:hover{background:var(--r2);border-color:var(--r2);color:#fff}
.btn-d{color:#EF4444;border-color:rgba(239,68,68,.2)}
.btn-d:hover{background:rgba(239,68,68,.08)}

/* â•â•â• SYNC BAR â•â•â• */
.sync{display:flex;align-items:center;gap:8px;padding:10px 16px;margin:0 0 16px;border-radius:var(--rd);background:var(--s1);border:1px solid var(--brd);font:400 11px var(--f);color:var(--t3);flex-wrap:wrap}
.sync b{color:var(--t2)}
.sync-btn{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;border:1px solid var(--brd2);background:var(--s2);color:var(--t3);font:500 10px var(--f);cursor:pointer;transition:all .15s;text-decoration:none}
.sync-btn:hover{border-color:var(--brd3);color:var(--t1)}
.sync-btn.green{border-color:rgba(34,197,94,.2);color:#22C55E}
.sync-btn.green:hover{background:rgba(34,197,94,.08)}

/* â•â•â• CATEGORIES â•â•â• */
.cats{display:flex;gap:6px;margin:0 0 16px;overflow-x:auto;padding:2px 0;scrollbar-width:none;-ms-overflow-style:none}
.cats::-webkit-scrollbar{display:none}
.cat{padding:8px 16px;border-radius:100px;border:1px solid var(--brd2);background:var(--s1);color:var(--t3);font:500 11px var(--f);cursor:pointer;white-space:nowrap;transition:all .15s;letter-spacing:.3px;text-transform:capitalize}
.cat:hover{border-color:var(--brd3);color:var(--t2)}
.cat.on{background:var(--r-bg);border-color:var(--r-brd);color:var(--r)}
.cat .cnt{font-size:10px;opacity:.6;margin-left:4px}

/* â•â•â• ALPHA TABS â•â•â• */
.alpha{display:flex;flex-wrap:wrap;gap:4px;margin:0 0 16px}
.al{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px;font:600 10px var(--fm);color:var(--t4);cursor:pointer;transition:all .15s;border:1px solid transparent}
.al:hover{color:var(--t2);background:var(--s2)}
.al.has{color:var(--t2)}
.al.on{background:var(--r-bg);border-color:var(--r-brd);color:var(--r)}

/* â•â•â• CONTACT CARDS â•â•â• */
.list{display:flex;flex-direction:column;gap:6px}
.letter-hd{font:700 11px var(--fm);color:var(--t4);letter-spacing:3px;text-transform:uppercase;padding:16px 0 6px;border-bottom:1px solid var(--brd)}
.ct{display:grid;grid-template-columns:48px 1fr auto;gap:14px;padding:16px;border-radius:var(--rd);background:var(--s1);border:1px solid var(--brd);cursor:pointer;transition:all .15s;position:relative;align-items:center}
.ct:hover{border-color:var(--brd2);background:var(--s2)}
.ct.op{background:var(--s2);border-color:var(--brd3)}

/* Avatar */
.av{width:48px;height:48px;border-radius:var(--rd2);display:flex;align-items:center;justify-content:center;font:700 15px var(--f);color:#fff;letter-spacing:-.5px;position:relative;overflow:hidden;flex-shrink:0}
.av::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.12),transparent 60%)}
.av-prov{background:var(--c-prov)}.av-cli{background:var(--c-cli)}.av-staff{background:var(--c-staff)}
.av-serv{background:var(--c-serv)}.av-pers{background:var(--c-pers)}.av-otro{background:var(--c-otro)}

/* Contact info */
.ci{min-width:0}
.ci .n{font:600 14px/1.3 var(--f);color:var(--t1);letter-spacing:-.3px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.ci .co{font:400 12px/1.3 var(--f);color:var(--t3);margin-top:2px}
.ci .it{font:400 11px/1.5 var(--f);color:var(--t3);margin-top:2px;display:flex;flex-wrap:wrap;gap:4px 12px}
.ci .it a{color:var(--c-prov);text-decoration:none}
.ci .it a:hover{text-decoration:underline}
.bg{display:inline-block;padding:2px 8px;border-radius:100px;font:600 9px var(--f);letter-spacing:.5px;text-transform:uppercase}
.bg-prov{background:rgba(59,130,246,.12);color:#60A5FA}
.bg-cli{background:rgba(16,185,129,.12);color:#34D399}
.bg-staff{background:rgba(245,158,11,.12);color:#FBBF24}
.bg-serv{background:rgba(139,92,246,.12);color:#A78BFA}
.bg-pers{background:rgba(236,72,153,.12);color:#F472B6}
.bg-otro{background:rgba(113,113,122,.12);color:#A1A1AA}

/* Actions */
.cr{display:flex;gap:4px;align-items:center;flex-shrink:0}
.cr button{width:32px;height:32px;border-radius:6px;border:1px solid var(--brd);background:transparent;color:var(--t4);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.cr button:hover{background:var(--s3);color:var(--t2);border-color:var(--brd2)}
.cr .del:hover{color:#EF4444;border-color:rgba(239,68,68,.3);background:rgba(239,68,68,.06)}
.ra{display:flex;gap:4px;margin-left:8px}
.ra a{width:28px;height:28px;border-radius:6px;border:1px solid var(--brd);display:flex;align-items:center;justify-content:center;color:var(--t4);text-decoration:none;transition:all .15s}
.ra a:hover{background:var(--s3);color:var(--t2)}
.ra .wpp:hover{color:#25D366;border-color:rgba(37,211,102,.3)}
.ra .phn:hover{color:var(--c-prov);border-color:rgba(59,130,246,.3)}

/* Expanded details */
.ex{display:none;grid-column:1/-1;border-top:1px solid var(--brd);padding-top:12px;margin-top:8px;font:400 12px/1.8 var(--f);color:var(--t3)}
.ex b{color:var(--t2);font-weight:600}
.ct.op .ex{display:block}

/* â•â•â• MODAL â•â•â• */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .2s}
.ov.on{opacity:1;pointer-events:auto}
.modal{background:var(--s1);border:1px solid var(--brd2);border-radius:var(--rd3);width:100%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:var(--sh3)}
.modal-hd{display:flex;justify-content:space-between;align-items:center;padding:20px 24px 16px;border-bottom:1px solid var(--brd)}
.modal-hd h2{font:700 16px var(--f);color:var(--t1)}
.modal-hd button{width:32px;height:32px;border-radius:8px;border:1px solid var(--brd);background:transparent;color:var(--t3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}
.modal-hd button:hover{background:var(--s3);color:var(--t1)}
.modal-body{padding:20px 24px}
.fg{margin-bottom:14px}
.fg label{display:block;font:500 11px var(--f);color:var(--t3);margin-bottom:6px;letter-spacing:.5px;text-transform:uppercase}
.fg input,.fg textarea,.fg select{width:100%;padding:10px 12px;border:1px solid var(--brd2);border-radius:var(--rd2);background:var(--s2);color:var(--t1);font:400 13px var(--f);outline:none;transition:border-color .2s}
.fg input:focus,.fg textarea:focus,.fg select:focus{border-color:var(--r)}
.fg input::placeholder,.fg textarea::placeholder{color:var(--t5)}
.fg select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='%2371717A' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
.fg select option{background:var(--s2);color:var(--t1)}
.fg textarea{resize:vertical;min-height:60px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.modal-ft{padding:16px 24px;border-top:1px solid var(--brd);display:flex;justify-content:flex-end;gap:8px}
.modal-ft .btn-ghost{background:transparent;border-color:var(--brd2);color:var(--t3)}
.modal-ft .btn-primary{background:var(--r);border-color:var(--r);color:#fff}
.modal-ft .btn-primary:hover{background:var(--r2)}

/* â•â•â• PIN OVERLAY â•â•â• */
.pin-ov{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(16px);z-index:300;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
.pin-ov.on{opacity:1;pointer-events:auto}
.pin-md{background:var(--s1);border:1px solid var(--brd2);border-radius:var(--rd3);padding:32px 28px;width:90%;max-width:340px;text-align:center}
.pin-icon{margin:0 auto 16px;width:48px;height:48px;border-radius:12px;background:var(--r-bg);border:1px solid var(--r-brd);display:flex;align-items:center;justify-content:center}
.pin-md h3{font:700 16px var(--f);color:var(--t1);margin-bottom:6px}
.pin-md>p{font:400 12px var(--f);color:var(--t3);margin-bottom:20px}
.pin-dots{display:flex;gap:12px;justify-content:center;margin-bottom:24px}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--brd3);background:transparent;transition:all .15s}
.pin-dot.filled{background:var(--r);border-color:var(--r)}
.pin-dot.err{border-color:#EF4444;background:#EF4444;animation:shake .3s}
@keyframes shake{25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:240px;margin:0 auto 16px}
.pin-btn{width:100%;aspect-ratio:1.4;border-radius:var(--rd2);border:1px solid var(--brd2);background:var(--s2);color:var(--t1);font:600 18px var(--f);cursor:pointer;transition:all .1s;display:flex;align-items:center;justify-content:center}
.pin-btn:hover{background:var(--s3);border-color:var(--brd3)}
.pin-btn:active{transform:scale(.95)}
.pin-del{font:500 12px var(--f);color:var(--t3)}
.pin-msg{font:500 12px var(--f);color:#EF4444;min-height:18px;margin-bottom:8px}
.pin-cancel{background:none;border:none;color:var(--t4);font:400 12px var(--f);cursor:pointer;padding:8px}
.pin-cancel:hover{color:var(--t2)}

/* â•â•â• FOOTER â•â•â• */
.fo{position:fixed;bottom:0;left:0;right:0;z-index:40;background:rgba(9,9,11,.95);backdrop-filter:blur(16px);border-top:1px solid var(--brd);padding:10px 20px env(safe-area-inset-bottom,10px)}
.fo-inner{max-width:880px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
.fo-brand{font:400 10px var(--f);color:var(--t5)}
.fo-actions{display:flex;gap:6px}
.fo-btn{padding:6px 12px;border-radius:6px;border:1px solid var(--brd);background:transparent;color:var(--t4);font:500 10px var(--f);cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:4px}
.fo-btn:hover{color:var(--t2);border-color:var(--brd2);background:var(--s2)}

/* â•â•â• TOAST â•â•â• */
.toast{position:fixed;bottom:calc(env(safe-area-inset-bottom,20px) + 60px);left:50%;transform:translateX(-50%) translateY(60px);background:var(--s3);color:var(--t1);padding:12px 24px;border-radius:100px;font:500 13px/1 var(--f);box-shadow:var(--sh3);z-index:200;opacity:0;transition:.3s cubic-bezier(.32,.72,0,1);display:flex;align-items:center;gap:8px;border:1px solid var(--brd2)}
.toast::before{content:'';width:6px;height:6px;background:var(--r);border-radius:50%;flex-shrink:0}
.toast.sh{transform:translateX(-50%) translateY(0);opacity:1}

/* â•â•â• EMPTY STATE â•â•â• */
.empty{text-align:center;padding:60px 20px;color:var(--t4)}
.empty svg{margin-bottom:16px;opacity:.3}
.empty p{font:400 13px var(--f)}

/* â•â•â• PRINT â•â•â• */
@media print{
  *{color:#111!important;background:#fff!important;box-shadow:none!important;border-color:#e0e0e0!important}
  .hd,.tb,.sync,.cats,.alpha,.fo,.ov,.pin-ov,.toast,.cr,.ra,.btn,.lock-btn,.sync-bar{display:none!important}
  .app{max-width:100%;padding:0;margin:0}
  body{font-size:10pt}
  .ct{border:1px solid #ddd;padding:8px 10px;margin-bottom:3px;page-break-inside:avoid}
  .ct:hover{transform:none}
  .av{width:32px;height:32px;font-size:10px;border-radius:4px;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .ci .n{font-size:11px}.ci .co{font-size:9px}.ci .it{font-size:9px}
  .bg{border:1px solid currentColor;font-size:7px;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .ex{display:block!important;border-top:1px solid #eee;font-size:9px}
  .p-hd{display:block!important;text-align:center;padding:8px 0 12px;border-bottom:2px solid #DC2626;margin-bottom:12px}
  .p-hd h1{font:700 16pt var(--f);color:#111}
  .p-hd p{font:400 8pt var(--f);color:#888;margin-top:2px}
  .p-ft{display:block!important;position:fixed;bottom:0;left:0;right:0;text-align:center;font:400 7pt var(--f);color:#aaa;padding:4px;border-top:1px solid #ddd}
}
.p-hd,.p-ft{display:none}

/* â•â•â• RESPONSIVE â•â•â• */
@media(max-width:768px){
  .app{padding:0 16px 100px}
  .hd{margin:0 -16px;padding:0 16px}
  .stat b{font-size:18px}
  .al{width:24px;height:24px;font-size:9px}
  .ct{grid-template-columns:42px 1fr auto;gap:10px;padding:14px}
  .av{width:42px;height:42px;font-size:13px}
}
@media(max-width:480px){
  .hd-r{gap:12px}.stat b{font-size:16px}
  .alpha{display:none}
  .ct{grid-template-columns:38px 1fr}
  .cr{position:absolute;top:12px;right:12px}
  .ra{display:none}
  .fr{grid-template-columns:1fr}
  .sync{font-size:10px}
  .cats .cat{padding:6px 12px;font-size:11px}
}
</style>
</head>
<body>

<div class="sync-bar" id="syncBar"></div>

<div class="app">
  <!-- Print header -->
  <div class="p-hd"><h1>DOCKS DEL PUERTO â€” Agenda de Contactos</h1><p>Tigre, Buenos Aires Â· Impreso: <script>document.write(new Date().toLocaleDateString('es-AR'))</script></p></div>

  <!-- HEADER -->
  <div class="hd"><div class="hd-top">
    <div class="hd-brand">
      <div class="hd-mark">DP</div>
      <div><div class="hd-name">Agenda de Contactos</div><div class="hd-sub">Docks del Puerto Â· Tigre</div></div>
    </div>
    <div class="hd-r">
      <div class="stat"><b id="sT">0</b><span>Contactos</span></div>
      <div class="stat"><b id="sC">0</b><span>CategorÃ­as</span></div>
      <button class="lock-btn" id="lockBtn" onclick="toggleLock()" title="Bloquear/Desbloquear">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      </button>
    </div>
  </div></div>

  <!-- TOOLBAR -->
  <div class="tb">
    <div class="sb"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg><input class="si" id="q" placeholder="Buscar nombre, empresa, telÃ©fono..."></div>
    <button class="btn btn-r" onclick="openM()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>Nuevo</button>
    <button class="btn btn-d" id="btnD" onclick="clr()" style="display:none">Borrar todo</button>
  </div>

  <!-- SYNC INFO -->
  <div class="sync">
    <span class="conn-dot" id="connDot"></span>
    <span id="syncStatus"><b>Firebase:</b> Conectando...</span>
    <div style="margin-left:auto;display:flex;gap:6px;flex-wrap:wrap">
      <button class="sync-btn" onclick="expC()">â†‘ CSV</button>
      <button class="sync-btn" onclick="impC()">â†“ CSV</button>
      <button class="sync-btn green" onclick="impW()">WhatsApp .vcf</button>
    </div>
  </div>

  <!-- CATEGORIES -->
  <div class="cats" id="cats"></div>

  <!-- ALPHA TABS -->
  <div class="alpha" id="alpha"></div>

  <!-- CONTACT LIST -->
  <div class="list" id="list"></div>

  <!-- Print footer -->
  <div class="p-ft">Docks del Puerto â€” Tigre, Buenos Aires Â· docksdelpuerto.com.ar</div>
</div>

<!-- FOOTER -->
<div class="fo"><div class="fo-inner">
  <span class="fo-brand">Docks del Puerto Â· Tigre, Buenos Aires</span>
  <div class="fo-actions">
    <button class="fo-btn" onclick="expC()">â†‘ CSV</button>
    <button class="fo-btn" onclick="window.print()">ğŸ–¶ A4</button>
  </div>
</div></div>

<!-- MODAL -->
<div class="ov" id="ov">
  <div class="modal">
    <div class="modal-hd">
      <h2 id="mT">Nuevo Contacto</h2>
      <button onclick="clM()">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="eId">
      <div class="fr">
        <div class="fg"><label>Nombre *</label><input id="fN" placeholder="Juan"></div>
        <div class="fg"><label>Apellido</label><input id="fA" placeholder="PÃ©rez"></div>
      </div>
      <div class="fr">
        <div class="fg"><label>Empresa</label><input id="fE" placeholder="Distribuidora ABC"></div>
        <div class="fg"><label>CategorÃ­a</label><select id="fC"><option value="proveedor">Proveedor</option><option value="cliente">Cliente</option><option value="staff">Staff</option><option value="servicio">Servicio</option><option value="personal">Personal</option><option value="otro">Otro</option></select></div>
      </div>
      <div class="fr">
        <div class="fg"><label>TelÃ©fono *</label><input id="fT" placeholder="+54 11 1234-5678"></div>
        <div class="fg"><label>Tel. Alt.</label><input id="fT2"></div>
      </div>
      <div class="fr">
        <div class="fg"><label>Email</label><input id="fM"></div>
        <div class="fg"><label>DirecciÃ³n</label><input id="fD"></div>
      </div>
      <div class="fr">
        <div class="fg"><label>CUIT / DNI</label><input id="fCU"></div>
        <div class="fg"><label>Local / Zona</label><input id="fL"></div>
      </div>
      <div class="fg"><label>Notas</label><textarea id="fNO" placeholder="Observaciones..."></textarea></div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-ghost" onclick="clM()">Cancelar</button>
      <button class="btn btn-primary" onclick="save()">Guardar</button>
    </div>
  </div>
</div>

<!-- PIN Overlay -->
<div class="pin-ov" id="pinOv">
  <div class="pin-md">
    <div class="pin-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
    <h3 id="pinTitle">Crear PIN de Administrador</h3>
    <p id="pinDesc">ElegÃ­ un PIN de 4 dÃ­gitos para proteger la agenda</p>
    <div class="pin-dots"><div class="pin-dot" id="pd0"></div><div class="pin-dot" id="pd1"></div><div class="pin-dot" id="pd2"></div><div class="pin-dot" id="pd3"></div></div>
    <div class="pin-pad">
      <button class="pin-btn" onclick="pinKey('1')">1</button>
      <button class="pin-btn" onclick="pinKey('2')">2</button>
      <button class="pin-btn" onclick="pinKey('3')">3</button>
      <button class="pin-btn" onclick="pinKey('4')">4</button>
      <button class="pin-btn" onclick="pinKey('5')">5</button>
      <button class="pin-btn" onclick="pinKey('6')">6</button>
      <button class="pin-btn" onclick="pinKey('7')">7</button>
      <button class="pin-btn" onclick="pinKey('8')">8</button>
      <button class="pin-btn" onclick="pinKey('9')">9</button>
      <button class="pin-btn pin-del" onclick="pinClear()">Borrar</button>
      <button class="pin-btn" onclick="pinKey('0')">0</button>
      <button class="pin-btn pin-del" onclick="pinBack()">&#9003;</button>
    </div>
    <div class="pin-msg" id="pinMsg"></div>
    <button class="pin-cancel" onclick="pinClose()">Cancelar</button>
  </div>
</div>

<!-- Hidden file inputs -->
<input type="file" id="csvF" accept=".csv" style="display:none" onchange="hCSV(event)">
<input type="file" id="vcfF" accept=".vcf" style="display:none" onchange="hVCF(event)" multiple>
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG â€” REEMPLAZÃ CON TU PROYECTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyCP0NJQbBBf-EP4auR88ms6TyfU137DTA",
  authDomain: "agenda-docks-puerto.firebaseapp.com",
  databaseURL: "https://agenda-docks-puerto-default-rtdb.firebaseio.com",
  projectId: "agenda-docks-puerto",
  storageBucket: "agenda-docks-puerto.firebasestorage.app",
  messagingSenderId: "1099185738215",
  appId: "1:1099185738215:web:fe15df8618075b4f1ead42",
  measurementId: "G-P6GJVC1VW5"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const fbDb = firebase.database();
const contactsRef = fbDb.ref('contacts');
const pinRef = fbDb.ref('admin/pinHash');
const metaRef = fbDb.ref('meta');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let db = [];
let cF = 'todos';
let cL = null;
let pinUnlocked = false;
let pinInput = '';
let pinMode = '';
let pinSetupFirst = '';
let pinCB = null;
let isOnline = false;
let cachedPinHash = null;

const AVC = {proveedor:'av-prov',cliente:'av-cli',staff:'av-staff',servicio:'av-serv',personal:'av-pers',otro:'av-otro'};
const BGC = {proveedor:'bg-prov',cliente:'bg-cli',staff:'bg-staff',servicio:'bg-serv',personal:'bg-pers',otro:'bg-otro'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE REALTIME SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFirebase() {
  // Connection state
  fbDb.ref('.info/connected').on('value', snap => {
    isOnline = snap.val() === true;
    updateConnUI();
  });

  // Listen for contacts changes in realtime
  contactsRef.on('value', snap => {
    const data = snap.val();
    if (data) {
      // Convert Firebase object to array
      db = Object.keys(data).map(k => ({...data[k], _fbKey: k}));
    } else {
      db = [];
    }
    showSyncBar('online');
    rA();
  }, err => {
    console.error('Firebase read error:', err);
    toast('Error de conexiÃ³n con Firebase');
    showSyncBar('offline');
    // Fallback to localStorage
    const local = localStorage.getItem('agenda_fb_backup');
    if (local) { try { db = JSON.parse(local); rA(); } catch(e){} }
  });

  // Listen for PIN changes
  pinRef.on('value', snap => {
    cachedPinHash = snap.val();
    updateLockUI();
  });
}

function showSyncBar(state) {
  const bar = document.getElementById('syncBar');
  bar.className = 'sync-bar ' + state;
}

function updateConnUI() {
  const dot = document.getElementById('connDot');
  const status = document.getElementById('syncStatus');
  if (isOnline) {
    dot.className = 'conn-dot';
    status.innerHTML = '<b>Firebase:</b> Conectado Â· Tiempo real';
  } else {
    dot.className = 'conn-dot offline';
    status.innerHTML = '<b>Firebase:</b> Sin conexiÃ³n Â· Modo offline';
  }
}

// Save contacts to Firebase
function fbSave(callback) {
  const obj = {};
  db.forEach(c => {
    const key = c._fbKey || c.id || gid();
    const clean = {...c};
    delete clean._fbKey;
    obj[key] = clean;
  });
  showSyncBar('syncing');
  contactsRef.set(obj).then(() => {
    showSyncBar('online');
    // Backup to localStorage
    localStorage.setItem('agenda_fb_backup', JSON.stringify(db));
    if (callback) callback();
  }).catch(err => {
    console.error('Firebase write error:', err);
    toast('Error guardando â€” reintentando...');
    showSyncBar('offline');
    // Save locally as backup
    localStorage.setItem('agenda_fb_backup', JSON.stringify(db));
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIN SYSTEM (Firebase-backed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hashPin(p) {
  let h = 0;
  const s = 'docks_' + p + '_admin';
  for (let i = 0; i < s.length; i++) { h = ((h << 5) - h) + s.charCodeAt(i); h |= 0; }
  return 'pin_' + Math.abs(h).toString(36);
}

function hasPin() { return !!cachedPinHash; }

function verifyPin(p) { return hashPin(p) === cachedPinHash; }

function setPin(p) {
  const h = hashPin(p);
  cachedPinHash = h;
  pinRef.set(h);
}

function updateLockUI() {
  const b = document.getElementById('lockBtn');
  if (!b) return;
  if (pinUnlocked) {
    b.classList.add('unlocked');
    b.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 5-5 5 5 0 0 1 5 5"/></svg>';
  } else {
    b.classList.remove('unlocked');
    b.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>';
  }
  // Show/hide delete button
  document.getElementById('btnD').style.display = pinUnlocked ? '' : 'none';
}

function updatePinDots() {
  for (let i = 0; i < 4; i++) {
    const d = document.getElementById('pd' + i);
    d.className = 'pin-dot' + (i < pinInput.length ? ' filled' : '');
  }
}

function showPinError(msg) {
  document.getElementById('pinMsg').textContent = msg;
  for (let i = 0; i < 4; i++) document.getElementById('pd' + i).classList.add('err');
  setTimeout(() => {
    pinInput = '';
    updatePinDots();
    document.getElementById('pinMsg').textContent = '';
    for (let i = 0; i < 4; i++) document.getElementById('pd' + i).classList.remove('err');
  }, 600);
}

function pinKey(n) {
  if (pinInput.length >= 4) return;
  pinInput += n;
  updatePinDots();
  if (pinInput.length === 4) setTimeout(processPinEntry, 200);
}
function pinBack() { if (pinInput.length > 0) { pinInput = pinInput.slice(0, -1); updatePinDots(); } }
function pinClear() { pinInput = ''; updatePinDots(); }
function pinClose() {
  document.getElementById('pinOv').classList.remove('on');
  pinInput = ''; pinMode = ''; pinCB = null; pinSetupFirst = '';
  updatePinDots();
  document.getElementById('pinMsg').textContent = '';
}

function processPinEntry() {
  if (pinMode === 'setup') {
    pinSetupFirst = pinInput; pinInput = ''; updatePinDots();
    document.getElementById('pinTitle').textContent = 'ConfirmÃ¡ tu PIN';
    document.getElementById('pinDesc').textContent = 'IngresÃ¡ el mismo PIN de nuevo';
    pinMode = 'setup-confirm';
    return;
  }
  if (pinMode === 'setup-confirm') {
    if (pinInput === pinSetupFirst) {
      setPin(pinInput);
      pinUnlocked = true;
      updateLockUI();
      pinClose();
      toast('PIN creado âœ“ â€” Funciona en todos los dispositivos');
      if (pinCB) { const cb = pinCB; pinCB = null; cb(); }
    } else {
      showPinError('Los PIN no coinciden');
      pinMode = 'setup'; pinSetupFirst = '';
      document.getElementById('pinTitle').textContent = 'Crear PIN de Administrador';
      document.getElementById('pinDesc').textContent = 'ElegÃ­ un PIN de 4 dÃ­gitos';
    }
    return;
  }
  if (pinMode === 'verify') {
    if (verifyPin(pinInput)) {
      pinUnlocked = true;
      updateLockUI();
      pinClose();
      toast('Desbloqueado âœ“');
      if (pinCB) { const cb = pinCB; pinCB = null; cb(); }
    } else {
      showPinError('PIN incorrecto');
    }
    return;
  }
}

function requirePin(callback) {
  if (pinUnlocked) { callback(); return; }
  pinCB = callback;
  pinInput = ''; pinSetupFirst = ''; updatePinDots();
  document.getElementById('pinMsg').textContent = '';
  if (!hasPin()) {
    pinMode = 'setup';
    document.getElementById('pinTitle').textContent = 'Crear PIN de Administrador';
    document.getElementById('pinDesc').textContent = 'ElegÃ­ un PIN de 4 dÃ­gitos para proteger la agenda';
  } else {
    pinMode = 'verify';
    document.getElementById('pinTitle').textContent = 'IngresÃ¡ tu PIN';
    document.getElementById('pinDesc').textContent = 'PIN de 4 dÃ­gitos requerido';
  }
  document.getElementById('pinOv').classList.add('on');
}

function toggleLock() {
  if (pinUnlocked) { pinUnlocked = false; updateLockUI(); toast('SesiÃ³n bloqueada'); return; }
  if (!hasPin()) {
    pinCB = null; pinInput = ''; pinSetupFirst = '';
    pinMode = 'setup';
    document.getElementById('pinTitle').textContent = 'Crear PIN de Administrador';
    document.getElementById('pinDesc').textContent = 'ElegÃ­ un PIN de 4 dÃ­gitos para proteger la agenda';
    document.getElementById('pinMsg').textContent = '';
    updatePinDots();
    document.getElementById('pinOv').classList.add('on');
    return;
  }
  pinCB = null; pinInput = '';
  pinMode = 'verify';
  document.getElementById('pinTitle').textContent = 'IngresÃ¡ tu PIN';
  document.getElementById('pinDesc').textContent = 'Desbloquear sesiÃ³n de administrador';
  document.getElementById('pinMsg').textContent = '';
  updatePinDots();
  document.getElementById('pinOv').classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gid() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('sh');
  clearTimeout(t._tm);
  t._tm = setTimeout(() => t.classList.remove('sh'), 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rA() {
  renderCats();
  renderAlpha();
  render();
  updateStats();
}

function updateStats() {
  document.getElementById('sT').textContent = db.length;
  const cats = new Set(db.map(c => c.categoria).filter(Boolean));
  document.getElementById('sC').textContent = cats.size;
}

function renderCats() {
  const counts = {};
  db.forEach(c => { const k = c.categoria || 'otro'; counts[k] = (counts[k] || 0) + 1; });
  const allCats = ['todos','proveedor','cliente','staff','servicio','personal','otro'];
  let h = '';
  allCats.forEach(c => {
    const cnt = c === 'todos' ? db.length : (counts[c] || 0);
    const on = cF === c ? ' on' : '';
    h += `<button class="cat${on}" onclick="fCat('${c}')">${c}<span class="cnt">${cnt}</span></button>`;
  });
  document.getElementById('cats').innerHTML = h;
}

function renderAlpha() {
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
  const has = new Set();
  db.forEach(c => { const l = (c.nombre || '')[0]; if (l) has.add(l.toUpperCase()); });
  let h = '<button class="al' + (!cL ? ' on' : '') + '" onclick="fL(null)">âŠ•</button>';
  letters.forEach(l => {
    const cls = (cL === l ? ' on' : '') + (has.has(l) ? ' has' : '');
    h += `<button class="al${cls}" onclick="fL('${l}')">${l}</button>`;
  });
  document.getElementById('alpha').innerHTML = h;
}

function render() {
  const q = (document.getElementById('q').value || '').toLowerCase();
  let filtered = db.filter(c => {
    if (cF !== 'todos' && c.categoria !== cF) return false;
    if (cL && (c.nombre || '')[0]?.toUpperCase() !== cL) return false;
    if (q) {
      const s = [c.nombre, c.apellido, c.empresa, c.telefono, c.telefono2, c.email, c.local, c.notas].join(' ').toLowerCase();
      return s.includes(q);
    }
    return true;
  });

  filtered.sort((a, b) => (a.nombre || '').localeCompare(b.nombre || '', 'es'));

  if (!filtered.length) {
    document.getElementById('list').innerHTML = `<div class="empty"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg><p>${q || cF !== 'todos' || cL ? 'Sin resultados para este filtro' : 'No hay contactos â€” tocÃ¡ + Nuevo para agregar'}</p></div>`;
    return;
  }

  // Group by letter
  const groups = {};
  filtered.forEach(c => {
    const l = (c.nombre || '?')[0].toUpperCase();
    if (!groups[l]) groups[l] = [];
    groups[l].push(c);
  });

  let h = '';
  Object.keys(groups).sort().forEach(letter => {
    h += `<div class="letter-hd">${letter}</div>`;
    groups[letter].forEach(c => {
      const avCls = AVC[c.categoria] || 'av-otro';
      const bgCls = BGC[c.categoria] || 'bg-otro';
      const initials = ((c.nombre || '?')[0] + (c.apellido || '')[0]).toUpperCase();
      const tel = c.telefono || '';
      const telClean = tel.replace(/[^+\d]/g, '');

      h += `<div class="ct" id="c_${c.id}" onclick="togC('${c.id}')">
  <div class="av ${avCls}">${initials}</div>
  <div class="ci">
    <div class="n">${esc(c.nombre)}${c.apellido ? ' ' + esc(c.apellido) : ''} <span class="bg ${bgCls}">${c.categoria || 'otro'}</span></div>
    ${c.empresa ? `<div class="co">${esc(c.empresa)}</div>` : ''}
    <div class="it">
      ${tel ? `<a href="tel:${telClean}" onclick="event.stopPropagation()">${esc(tel)}</a>` : ''}
      ${c.email ? `<a href="mailto:${c.email}" onclick="event.stopPropagation()">${esc(c.email)}</a>` : ''}
    </div>
  </div>
  <div class="cr">
    ${telClean ? `<div class="ra"><a class="wpp" href="https://wa.me/${telClean.replace('+','')}" target="_blank" onclick="event.stopPropagation()" title="WhatsApp"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2 22l4.832-1.438A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2z"/></svg></a><a class="phn" href="tel:${telClean}" onclick="event.stopPropagation()" title="Llamar"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg></a></div>` : ''}
    <button onclick="event.stopPropagation();requirePin(()=>ed('${c.id}'))" title="Editar"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
    <button class="del" onclick="event.stopPropagation();requirePin(()=>del('${c.id}'))" title="Eliminar"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
  </div>
  <div class="ex">${c.telefono2 ? '<b>Tel Alt:</b> ' + esc(c.telefono2) + '<br>' : ''}${c.direccion ? '<b>Dir:</b> ' + esc(c.direccion) + '<br>' : ''}${c.cuit ? '<b>CUIT:</b> ' + esc(c.cuit) + '<br>' : ''}${c.local ? '<b>Local:</b> ' + esc(c.local) + '<br>' : ''}${c.notas ? '<b>Notas:</b> ' + esc(c.notas) : ''}</div>
</div>`;
    });
  });

  document.getElementById('list').innerHTML = h;
}

function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function togC(id) { document.getElementById('c_' + id)?.classList.toggle('op'); }
function fL(l) { cL = l; rA(); }
function fCat(c) { cF = c; rA(); }
document.getElementById('q').addEventListener('input', () => render());

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRUD (Firebase-backed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openM(d) {
  document.getElementById('ov').classList.add('on');
  const flds = ['N','A','E','T','T2','M','D','CU','L','NO'];
  const keys = ['nombre','apellido','empresa','telefono','telefono2','email','direccion','cuit','local','notas'];
  if (d) {
    document.getElementById('mT').textContent = 'Editar Contacto';
    document.getElementById('eId').value = d.id;
    flds.forEach((f, i) => document.getElementById('f' + f).value = d[keys[i]] || '');
    document.getElementById('fC').value = d.categoria || 'proveedor';
  } else {
    document.getElementById('mT').textContent = 'Nuevo Contacto';
    document.getElementById('eId').value = '';
    flds.forEach(f => document.getElementById('f' + f).value = '');
    document.getElementById('fC').value = 'proveedor';
  }
}

function clM() { document.getElementById('ov').classList.remove('on'); }

function save() {
  const n = document.getElementById('fN').value.trim();
  const t = document.getElementById('fT').value.trim();
  if (!n) { toast('Nombre obligatorio'); return; }

  const data = {
    nombre: n,
    apellido: document.getElementById('fA').value.trim(),
    empresa: document.getElementById('fE').value.trim(),
    categoria: document.getElementById('fC').value,
    telefono: t,
    telefono2: document.getElementById('fT2').value.trim(),
    email: document.getElementById('fM').value.trim(),
    direccion: document.getElementById('fD').value.trim(),
    cuit: document.getElementById('fCU').value.trim(),
    local: document.getElementById('fL').value.trim(),
    notas: document.getElementById('fNO').value.trim()
  };

  const eid = document.getElementById('eId').value;
  if (eid) {
    const idx = db.findIndex(c => c.id === eid);
    if (idx !== -1) { db[idx] = {...db[idx], ...data}; toast('Contacto actualizado'); }
  } else {
    data.id = gid();
    db.push(data);
    toast('Contacto agregado');
  }

  fbSave();
  clM();
}

function ed(id) { const c = db.find(x => x.id === id); if (c) openM(c); }

function del(id) {
  if (!confirm('Â¿Eliminar este contacto?')) return;
  db = db.filter(c => c.id !== id);
  fbSave();
  toast('Contacto eliminado');
}

function clr() {
  requirePin(() => {
    if (!confirm('Â¿Borrar TODOS los contactos? Esta acciÃ³n se sincroniza en todos los dispositivos.')) return;
    db = [];
    fbSave();
    toast('Todos los contactos eliminados');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function expC() {
  const h = ['nombre','apellido','empresa','categoria','telefono','telefono2','email','direccion','cuit','local','notas'];
  let csv = h.join(',') + '\n';
  db.forEach(c => {
    csv += h.map(k => { let v = (c[k] || '').toString(); if (v.includes(',') || v.includes('"')) v = '"' + v.replace(/"/g, '""') + '"'; return v; }).join(',') + '\n';
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob(['\ufeff' + csv], {type:'text/csv'}));
  a.download = 'agenda_docks_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
  toast('CSV exportado');
}

function impC() { requirePin(() => document.getElementById('csvF').click()); }
function impW() { requirePin(() => document.getElementById('vcfF').click()); }

function hCSV(ev) {
  const f = ev.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = e => {
    const ls = e.target.result.split(/\r?\n/).filter(l => l.trim());
    if (ls.length < 2) { toast('CSV vacÃ­o'); return; }
    const hd = ls[0].split(',').map(h => h.trim().toLowerCase().replace(/['"]/g, ''));
    const m = {};
    hd.forEach((h, i) => {
      if (['nombre','name','first_name'].includes(h)) m.nombre = i;
      else if (['apellido','lastname','last_name','surname'].includes(h)) m.apellido = i;
      else if (['empresa','company','razon_social'].includes(h)) m.empresa = i;
      else if (['categoria','category','tipo'].includes(h)) m.categoria = i;
      else if (['telefono','phone','tel','celular','mobile'].includes(h)) m.telefono = i;
      else if (['telefono2','phone2','tel2','tel_alt'].includes(h)) m.telefono2 = i;
      else if (['email','correo','mail'].includes(h)) m.email = i;
      else if (['direccion','address','domicilio'].includes(h)) m.direccion = i;
      else if (['cuit','dni','documento'].includes(h)) m.cuit = i;
      else if (['local','zona','location'].includes(h)) m.local = i;
      else if (['notas','notes','observaciones'].includes(h)) m.notas = i;
    });

    let added = 0;
    for (let i = 1; i < ls.length; i++) {
      const vals = ls[i].split(',');
      const c = {
        id: gid(),
        nombre: vals[m.nombre] || '',
        apellido: vals[m.apellido] || '',
        empresa: vals[m.empresa] || '',
        categoria: vals[m.categoria] || 'otro',
        telefono: vals[m.telefono] || '',
        telefono2: vals[m.telefono2] || '',
        email: vals[m.email] || '',
        direccion: vals[m.direccion] || '',
        cuit: vals[m.cuit] || '',
        local: vals[m.local] || '',
        notas: vals[m.notas] || ''
      };
      if (c.nombre || c.telefono) { db.push(c); added++; }
    }
    if (added) {
      fbSave();
      toast(added + ' contactos importados');
    }
  };
  r.readAsText(f);
  ev.target.value = '';
}

function hVCF(ev) {
  const files = ev.target.files;
  if (!files.length) return;
  let totalAdded = 0;

  const processFile = (file) => new Promise(resolve => {
    const r = new FileReader();
    r.onload = e => {
      const text = e.target.result;
      const cards = text.split('BEGIN:VCARD').filter(s => s.trim());
      let added = 0;

      cards.forEach(card => {
        const lines = card.split(/\r?\n/);
        const c = { id: gid(), nombre: '', apellido: '', empresa: '', categoria: 'personal', telefono: '', telefono2: '', email: '', direccion: '', cuit: '', local: '', notas: '' };
        let phones = [];

        lines.forEach(line => {
          // Name
          if (line.startsWith('FN:') || line.startsWith('FN;')) {
            const val = line.split(':').slice(1).join(':').trim();
            const parts = val.split(' ');
            c.nombre = parts[0] || '';
            c.apellido = parts.slice(1).join(' ') || '';
          }
          // Phone - match any line containing TEL
          if (line.toUpperCase().includes('TEL')) {
            const val = line.split(':').slice(1).join(':').trim();
            if (val && val.length > 4) phones.push(val);
          }
          // Email
          if (line.toUpperCase().includes('EMAIL')) {
            c.email = line.split(':').slice(1).join(':').trim();
          }
          // Organization
          if (line.startsWith('ORG:') || line.startsWith('ORG;')) {
            c.empresa = line.split(':').slice(1).join(':').replace(/;/g, ' ').trim();
          }
          // WhatsApp business name
          if (line.startsWith('X-WA-BIZ-NAME:')) {
            const biz = line.split(':').slice(1).join(':').trim();
            if (biz && !c.empresa) c.empresa = biz;
          }
          // Address
          if (line.toUpperCase().includes('ADR')) {
            const parts = line.split(':').slice(1).join(':').split(';').filter(Boolean);
            c.direccion = parts.join(', ').trim();
          }
          // Notes
          if (line.startsWith('NOTE:')) {
            c.notas = line.split(':').slice(1).join(':').trim();
          }
        });

        if (phones.length > 0) c.telefono = phones[0];
        if (phones.length > 1) c.telefono2 = phones[1];

        // Check duplicates by phone
        if (c.telefono) {
          const cleanTel = c.telefono.replace(/[^+\d]/g, '');
          const exists = db.some(x => x.telefono && x.telefono.replace(/[^+\d]/g, '') === cleanTel);
          if (!exists && (c.nombre || c.telefono)) { db.push(c); added++; }
        } else if (c.nombre) {
          db.push(c); added++;
        }
      });

      totalAdded += added;
      resolve();
    };
    r.readAsText(file);
  });

  Promise.all(Array.from(files).map(processFile)).then(() => {
    if (totalAdded) {
      fbSave();
      toast(totalAdded + ' contactos importados desde WhatsApp');
    } else {
      toast('No se encontraron contactos nuevos');
    }
  });

  ev.target.value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); document.getElementById('q').focus(); }
  if (e.key === 'Escape') {
    if (document.getElementById('pinOv').classList.contains('on')) pinClose();
    else if (document.getElementById('ov').classList.contains('on')) clM();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initFirebase();
updateLockUI();
</script>
</body>
</html>
